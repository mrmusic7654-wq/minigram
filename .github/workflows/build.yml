name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Fix Gradle duplicates and update pubspec
      run: |
        # Fix settings.gradle duplicate
        if [ -f "android/settings.gradle" ] && [ -f "android/settings.gradle.kts" ]; then
          rm android/settings.gradle
        fi
        
        # Update Gradle wrapper
        cd android
        sed -i 's|distributionUrl=.*|distributionUrl=https\://services.gradle.org/distributions/gradle-8.1-all.zip|' gradle/wrapper/gradle-wrapper.properties
        cd ..
        
        # Update pubspec.yaml to use exact versions
        sed -i 's/^  flutter_dotenv: \^[0-9]/  flutter_dotenv: 5.1.0/' pubspec.yaml
        sed -i 's/^  provider: \^[0-9]/  provider: 6.1.1/' pubspec.yaml
        sed -i 's/^  http: \^[0-9]/  http: 1.1.2/' pubspec.yaml
        sed -i 's/^  shared_preferences: \^[0-9]/  shared_preferences: 2.2.2/' pubspec.yaml
        sed -i 's/^  flutter_form_builder: \^[0-9]/  flutter_form_builder: 9.3.0/' pubspec.yaml
        sed -i 's/^  go_router: \^[0-9]/  go_router: 13.2.5/' pubspec.yaml
        
        # Remove riverpod if exists (causes conflicts)
        sed -i '/riverpod:/d' pubspec.yaml
        sed -i '/riverpod_generator:/d' pubspec.yaml
        sed -i '/riverpod_annotation:/d' pubspec.yaml
        
        # Add dependency_overrides if not present
        if ! grep -q "dependency_overrides:" pubspec.yaml; then
          echo "
dependency_overrides:
  meta: 1.12.0
  analyzer: 6.4.1" >> pubspec.yaml
        fi
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.22.0
